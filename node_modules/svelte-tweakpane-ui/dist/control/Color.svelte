<script context="module"></script>

<script>
	import { isColorObject, isObject, isRgbColorObject, isRgbaColorObject } from '@tweakpane/core';
	import ClsPad from '../internal/ClsPad.svelte';
	import GenericInputFolding from '../internal/GenericInputFolding.svelte';
	import { objectToTuple, tupleToObject } from '../utils';
	import { fillWith } from '../utils';
	import { BROWSER } from 'esm-env';
	export let value;
	export let expanded = void 0;
	export let type = void 0;
	let internalValue;
	let options;
	let ref;
	const buttonClass = 'tp-colswv_b';
	function updateInternalValue() {
		if (Array.isArray(value)) {
			if (value.length === 4) {
				internalValue = tupleToObject(value, ['r', 'g', 'b', 'a']);
			} else if (value.length === 3) {
				internalValue = tupleToObject(value, ['r', 'g', 'b']);
			} else {
				console.error('Unreachable');
			}
		} else {
			internalValue = value;
		}
	}
	function updateValue() {
		if (Array.isArray(value) && isColorObject(internalValue)) {
			if (isRgbaColorObject(internalValue)) {
				value = objectToTuple(internalValue, ['r', 'g', 'b', 'a']);
			} else if (isRgbColorObject(internalValue)) {
				value = objectToTuple(internalValue, ['r', 'g', 'b']);
			} else {
				console.error('Unreachable');
			}
		} else if (typeof value === 'string') {
			value = internalValue;
		} else if (isObject(value)) {
			value = internalValue;
		} else {
			console.error('Unreachable');
		}
	}
	function addListeners() {
		ref.on('change', () => {
			ref.refresh();
		});
	}
	$: value, updateInternalValue();
	$: internalValue, updateValue();
	$: ref !== void 0 && addListeners();
	$: options = {
		color: {
			type
		},
		view: 'color'
	};
</script>

<GenericInputFolding
	bind:value={internalValue}
	bind:expanded
	bind:ref
	on:change
	{buttonClass}
	{options}
	{...$$restProps}
/>
{#if !BROWSER && expanded && $$props.picker === 'inline'}
	<!-- Main swatch -->
	<ClsPad keysAdd={fillWith('containerUnitSize', 6)} theme={$$props.theme} />
	<ClsPad keysAdd={fillWith('containerUnitSpacing', 3)} theme={$$props.theme} />
	{#if isRgbaColorObject(internalValue)}
		<ClsPad keysAdd={fillWith('containerUnitSize', 1)} theme={$$props.theme} />
		<ClsPad extra={2} keysAdd={fillWith('containerVerticalPadding', 2)} theme={$$props.theme} />
	{/if}
{/if}
