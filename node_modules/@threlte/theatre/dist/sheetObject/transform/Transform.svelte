<script>import { types } from '../../theatre';
import { T, watch } from '@threlte/core';
import { TransformControls } from '@threlte/extras';
import { onMount } from 'svelte';
import { Group } from 'three';
import { RAD2DEG } from 'three/src/math/MathUtils.js';
import { useStudio } from '../../studio/useStudio';
import { getDefaultTransformer } from '../transfomers/getDefaultTransformer';
export let label = undefined;
export let key = undefined;
export let mode = 'translate';
export let space = undefined;
export let translationSnap = undefined;
export let rotationSnap = undefined;
export let scaleSnap = undefined;
/** @package */
export let sheetObject;
/** @package */
export let addProps;
/** @package */
export let removeProps;
let controls;
$: if (controls) {
    if (translationSnap) {
        controls.setTranslationSnap(translationSnap);
    }
    else {
        controls.setTranslationSnap(null);
    }
    if (rotationSnap) {
        controls.setRotationSnap(rotationSnap);
    }
    else {
        controls.setRotationSnap(null);
    }
    if (scaleSnap) {
        controls.setScaleSnap(scaleSnap);
    }
    else {
        controls.setScaleSnap(null);
    }
}
const group = new Group();
const positionTransformer = getDefaultTransformer(group, 'position', 'position');
const rotationTransformer = getDefaultTransformer(group, 'rotation', 'rotation');
const scaleTransformer = getDefaultTransformer(group, 'scale', 'scale');
const initTransform = () => {
    const positionProp = positionTransformer.transform(group.position);
    const rotationProp = rotationTransformer.transform(group.rotation);
    const scaleProp = scaleTransformer.transform(group.scale);
    if (key) {
        addProps({
            [key]: types.compound({
                position: positionProp,
                rotation: rotationProp,
                scale: scaleProp
            }, {
                label: label ?? key
            })
        });
    }
    else {
        addProps({
            position: positionProp,
            rotation: rotationProp,
            scale: scaleProp
        });
    }
};
watch([sheetObject], ([sheetObject]) => {
    return sheetObject?.onValuesChange((values) => {
        let object = values;
        if (key) {
            if (!values[key])
                return;
            object = values[key];
        }
        else {
            if (!values.position || !values.rotation || !values.scale)
                return;
        }
        // sanity check
        if (!object)
            return;
        positionTransformer.apply(group, 'position', object.position);
        rotationTransformer.apply(group, 'rotation', object.rotation);
        scaleTransformer.apply(group, 'scale', object.scale);
    });
});
onMount(() => {
    initTransform();
    return () => {
        removeProps(key ? [key] : ['position', 'rotation', 'scale']);
    };
});
const studio = useStudio();
let scrub;
let isSelected = false;
watch([studio], ([studio]) => {
    return studio?.onSelectionChange((selection) => {
        if (!$sheetObject)
            return;
        isSelected = selection.includes($sheetObject);
    });
});
const onMouseDown = () => {
    if (!studio)
        return;
    if (scrub)
        return;
    scrub = $studio?.scrub();
};
const onChange = () => {
    if (!scrub)
        return;
    scrub.capture((api) => {
        if (!$sheetObject)
            return;
        const baseTarget = key ? $sheetObject.props[key] : $sheetObject.props;
        api.set(baseTarget.position, {
            ...group.position
        });
        api.set(baseTarget.rotation, {
            x: group.rotation.x * RAD2DEG,
            y: group.rotation.y * RAD2DEG,
            z: group.rotation.z * RAD2DEG
        });
        api.set(baseTarget.scale, {
            ...group.scale
        });
    });
};
const onMouseUp = () => {
    if (!scrub)
        return;
    scrub.commit();
    scrub = undefined;
};
const groupRef = group;
</script>

<T
  is={groupRef}
  let:ref
>
  {#if isSelected}
    <TransformControls
      object={ref}
      {mode}
      {space}
      bind:controls
      on:mouseDown={onMouseDown}
      on:objectChange={onChange}
      on:mouseUp={onMouseUp}
    />
  {/if}

  <slot />
</T>
