<script
 
  context="module"
>import { T, useThrelte, createRawEventDispatcher, useTask } from "@threlte/core";
import { isHandTracking, handDispatchers } from "../internal/stores";
import { left as leftStore, right as rightStore } from "../hooks/useHand";
import ScenePortal from "./internal/ScenePortal.svelte";
import { writable } from "svelte/store";
const stores = {
  left: leftStore,
  right: rightStore
};
</script>

<script>export let left = void 0;
export let right = void 0;
export let hand = void 0;
const dispatch = createRawEventDispatcher();
const { xr } = useThrelte().renderer;
const space = xr.getReferenceSpace();
const handedness = writable(left ? "left" : right ? "right" : hand);
$:
  handedness.set(left ? "left" : right ? "right" : hand);
$:
  handDispatchers[$handedness].set(dispatch);
let children;
const { start, stop } = useTask(
  () => {
    const frame = xr.getFrame();
    const joint = inputSource.get("wrist");
    if (joint === void 0 || space === null)
      return;
    const pose = frame.getJointPose?.(joint, space);
    if (pose === void 0 || pose === null)
      return;
    const { position, orientation } = pose.transform;
    children.position.set(position.x, position.y, position.z);
    children.quaternion.set(orientation.x, orientation.y, orientation.z, orientation.w);
  },
  { autoStart: false }
);
$:
  if ($isHandTracking && ($$slots.wrist || $$slots.default) && inputSource) {
    start();
  } else {
    stop();
  }
$:
  store = stores[$handedness];
$:
  inputSource = $store?.inputSource;
$:
  model = $store?.model;
</script>

{#if $store?.hand && $isHandTracking}
  <T is={$store.hand}>
    {#if $$slots.default === undefined}
      <T is={model} />
    {/if}
  </T>

  {#if $$slots['target-ray'] !== undefined}
    <T is={$store.targetRay}>
      <slot name="target-ray" />
    </T>
  {/if}
{/if}

{#if $isHandTracking}
  <ScenePortal>
    <T.Group bind:ref={children}>
      <slot name="wrist" />
      <slot />
    </T.Group>
  </ScenePortal>
{/if}
