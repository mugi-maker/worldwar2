import{BladeApi as t,BladeController as e,LabelController as r,ClassName as i,ManualTicker as a,IntervalTicker as n,Constants as s,createPlugin as l,parseRecord as o,ValueMap as h}from"@tweakpane/core";class c extends t{measureStart(t){this.controller.valueController.measureStart(t)}measureEnd(){return this.controller.valueController.measureEnd()}measure(t,e){this.controller.valueController.measure(t,e)}measureAsync(t,e){return this.controller.valueController.measureAsync(t,e)}get measureHandler(){return this.controller.valueController.measureHandler}set measureHandler(t){this.controller.valueController.measureHandler=t}}class d extends e{constructor(t,e){const i=e.valueController,a=new r(t,{blade:e.blade,props:e.labelProps,valueController:i});super({blade:e.blade,view:a.view,viewProps:i.viewProps}),this.valueController=i,this.labelController=a}}class _{measureStart(){const t=performance.now();return()=>performance.now()-t}}function u(t,e,r,i){return new(r||(r=Promise))((function(a,n){function s(t){try{o(i.next(t))}catch(t){n(t)}}function l(t){try{o(i.throw(t))}catch(t){n(t)}}function o(t){var e;t.done?a(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,l)}o((i=i.apply(t,e||[])).next())}))}class p{constructor(){this.map=new Map,this.keySet=new Set}get(t){return this.map.get(t)}getOrCreate(t,e){this.keySet.has(t)||this.keySet.add(t);let r=this.map.get(t);return null==r&&(r=e(),this.map.set(t,r)),r}set(t,e){this.keySet.has(t)||this.keySet.add(t),this.map.set(t,e)}resetUsedSet(){this.keySet.clear()}vaporize(t){for(const[e,r]of this.map.entries())this.keySet.has(e)||(this.map.delete(e),null==t||t([e,r]))}}function m(t){let e=0;return t.forEach((t=>e+=t)),e}class f{constructor(t){this.__recalcForEach=0,this.__countUntilRecalc=0,this.__history=[],this.__index=0,this.__count=0,this.__cache=0,this.__length=t,this.__recalcForEach=t;for(let e=0;e<t;e++)this.__history[e]=0}get mean(){const t=Math.min(this.__count,this.__length);return 0===t?0:this.__cache/t}get recalcForEach(){return this.__recalcForEach}set recalcForEach(t){const e=t-this.__recalcForEach;this.__recalcForEach=t,this.__countUntilRecalc=Math.max(0,this.__countUntilRecalc+e)}reset(){this.__index=0,this.__count=0,this.__cache=0,this.__countUntilRecalc=0;for(let t=0;t<this.__length;t++)this.__history[t]=0}push(t){const e=this.__history[this.__index];this.__history[this.__index]=t,this.__count++,this.__index=(this.__index+1)%this.__length,0===this.__countUntilRecalc?this.recalc():(this.__countUntilRecalc--,this.__cache-=e,this.__cache+=t)}recalc(){this.__countUntilRecalc=this.__recalcForEach;const t=this.__history.slice(0,Math.min(this.__count,this.__length)).reduce(((t,e)=>t+e),0);this.__cache=t}}function v(t,e){if("function"!=typeof e)return v(t,(t=>t<e));const r=e;let i=0,a=t.length;for(;i<a;){const e=i+a>>1;r(t[e])?i=e+1:a=e}return i}class g{constructor(t){this.__history=[],this.__sorted=[],this.__index=0,this.__length=t}get median(){return this.percentile(50)}percentile(t){return 0===this.__history.length?0:this.__sorted[Math.round(.01*t*(this.__history.length-1))]}reset(){this.__index=0,this.__history=[],this.__sorted=[]}push(t){const e=this.__history[this.__index];if(this.__history[this.__index]=t,this.__index=(this.__index+1)%this.__length,this.__sorted.length===this.__length){const t=v(this.__sorted,e);this.__sorted.splice(t,1)}const r=v(this.__sorted,t);this.__sorted.splice(r,0,t)}}function y(t,e){let r=0;for(let i=0;i<t.length;i++)r+=t[i]*e[i];return r}function C(t){return Math.min(Math.max(t,0),1)}function E(t){const e=[1,t=C(t),t*t,t*t*t],r=[e[2],e[3]].map((t=>t*e[2])),i=[y(e,[.13572138,4.6153926,-42.66032258,132.13108234])+y(r,[-152.94239396,59.28637943]),y(e,[.09140261,2.19418839,4.84296658,-14.18503333])+y(r,[4.27729857,2.82956604]),y(e,[.1066733,12.64194608,-60.58204836,110.36276771])+y(r,[-89.90310912,27.34824973])];return`rgb( ${i.map((t=>256*C(t))).join(", ")} )`}const w=i("profiler");class b{constructor(t,e){this.targetDelta=e.targetDelta,this.deltaUnit=e.deltaUnit,this.fractionDigits=e.fractionDigits,this.calcMode=e.calcMode,this.element=t.createElement("div"),this.element.classList.add(w()),e.viewProps.bindClassModifiers(this.element),this.svgRootElement_=t.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgRootElement_.classList.add(w("root")),this.element.appendChild(this.svgRootElement_),this.entryContainerElement_=t.createElementNS("http://www.w3.org/2000/svg","g"),this.entryContainerElement_.classList.add(w("container")),this.entryContainerElement_.setAttribute("transform","translate( 1, 1 )"),this.svgRootElement_.appendChild(this.entryContainerElement_),this.tooltipElement_=t.createElement("div"),this.tooltipElement_.classList.add(w("tooltip")),this.tooltipElement_.style.display="none",this.element.appendChild(this.tooltipElement_),this.tooltipInsideElement_=t.createElement("div"),this.tooltipInsideElement_.classList.add(w("tooltipinside")),this.tooltipElement_.appendChild(this.tooltipInsideElement_),this.labelElement_=t.createElement("div"),this.labelElement_.classList.add(w("label")),this.labelElement_.textContent=this.deltaToDisplayDelta_(0),this.element.appendChild(this.labelElement_),this.entryElementCacheMap_=new p,this.hoveringEntry_=null}update(t){const e=this.entryToDelta_(t);this.labelElement_.textContent=this.deltaToDisplayDelta_(e),this.entryElementCacheMap_.resetUsedSet();const r=160/Math.max(this.targetDelta,e);let i=0;for(const e of t.children){this.addEntry_(e,"",this.entryContainerElement_,r).setAttribute("transform",`translate( ${i}, 0 )`),i+=this.entryToDelta_(e)*r}this.entryElementCacheMap_.vaporize((([t,e])=>{e.remove(),this.hoveringEntry_===t&&(this.hoveringEntry_=null)})),this.updateTooltip_()}updateTooltip_(){const t=this.hoveringEntry_;if(t){const e=this.entryElementCacheMap_.get(t),r=null==e?void 0:e.getAttribute("data-delta"),i=`${t}\n${this.deltaToDisplayDelta_(parseFloat(null!=r?r:"0.0"))}`;this.tooltipElement_.style.display="block",this.tooltipInsideElement_.textContent=i}else this.tooltipElement_.style.display="none"}addEntry_(t,e,r,i){const a=`${e}/${t.name}`,n=this.entryElementCacheMap_.getOrCreate(a,(()=>{const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.classList.add(w("entry")),r.appendChild(t),this.entryElementCacheMap_.set(a,t);const e=document.createElementNS("http://www.w3.org/2000/svg","rect");return e.classList.add(w("entryrect")),t.appendChild(e),e.addEventListener("mouseenter",(()=>{this.hoveringEntry_=a,this.updateTooltip_()})),e.addEventListener("mouseleave",(()=>{this.hoveringEntry_=null,this.updateTooltip_()})),t})),s=this.entryToDelta_(t);n.setAttribute("data-delta",`${s}`);const l=n.childNodes[0];l.setAttribute("width",`${Math.max(.01,s*i-1)}px`),l.setAttribute("height","9px");const o=.15+.7*C(s/this.targetDelta);if(l.setAttribute("fill",E(o)),t.children.length>0){let e=0;t.children.forEach((t=>{this.addEntry_(t,a,n,i).setAttribute("transform",`translate( ${e}, 10 )`),e+=this.entryToDelta_(t)*i}))}return n}entryToDelta_(t){if("frame"===this.calcMode)return t.delta;if("mean"===this.calcMode)return t.deltaMean;if("median"===this.calcMode)return t.deltaMedian;throw new Error('Unreachable! calcMode must be one of "frame", "mean", or "median"')}deltaToDisplayDelta_(t){return`${t.toFixed(this.fractionDigits)} ${this.deltaUnit}`}}class M{constructor(t,e){this.targetDelta=e.targetDelta,this.bufferSize=e.bufferSize,this.onTick_=this.onTick_.bind(this),this.ticker_=e.ticker,this.ticker_.emitter.on("tick",this.onTick_),this.viewProps=e.viewProps,this.view=new b(t,{targetDelta:this.targetDelta,deltaUnit:e.deltaUnit,fractionDigits:e.fractionDigits,calcMode:e.calcMode,viewProps:this.viewProps}),this.viewProps.handleDispose((()=>{this.ticker_.dispose()})),this.measureHandler=e.measureHandler,this.rootCalcCacheStack_=[this.createNewEntryCalcCache_()]}measureStart(t){const e=this.rootCalcCacheStack_[this.rootCalcCacheStack_.length-1].childrenCacheMap.getOrCreate(t,(()=>this.createNewEntryCalcCache_()));var r;e.childrenCacheMap.resetUsedSet(),(r=e.childrenPromiseDelta).splice(0,r.length),this.rootCalcCacheStack_.push(e),e.measureEnd=this.measureHandler.measureStart()}measureEnd(){return u(this,void 0,void 0,(function*(){const t=this.rootCalcCacheStack_[this.rootCalcCacheStack_.length-1],e=this.rootCalcCacheStack_[this.rootCalcCacheStack_.length-2],r=Promise.resolve(t.measureEnd());t.measureEnd=null,e.childrenPromiseDelta.push(r),this.rootCalcCacheStack_.pop(),t.childrenCacheMap.vaporize();const i=m(yield Promise.all(t.childrenPromiseDelta)),a=(yield r)-i;t.meanCalc.push(a),t.medianCalc.push(a),t.latest=a}))}measure(t,e){this.measureStart(t),e(),this.measureEnd()}measureAsync(t,e){return u(this,void 0,void 0,(function*(){this.measureStart(t),yield e(),this.measureEnd()}))}renderEntry(){return this.renderEntryFromCalcCache_("",this.rootCalcCacheStack_[0])}renderEntryFromCalcCache_(t,e){const r=[];for(const t of e.childrenCacheMap.keySet){const i=e.childrenCacheMap.get(t);r.push(this.renderEntryFromCalcCache_(t,i))}const i=e.latest,a=e.meanCalc.mean,n=e.medianCalc.median;return{name:t,delta:i+m(r.map((t=>t.delta))),deltaMean:a+m(r.map((t=>t.deltaMean))),deltaMedian:n+m(r.map((t=>t.deltaMedian))),selfDelta:i,selfDeltaMean:a,selfDeltaMedian:n,children:r}}onTick_(){this.view.update(this.renderEntry())}createNewEntryCalcCache_(){return{meanCalc:new f(this.bufferSize),medianCalc:new g(this.bufferSize),latest:0,measureEnd:null,childrenCacheMap:new p,childrenPromiseDelta:[]}}}function S(t,e){return 0===e?new a:new n(t,null!=e?e:s.monitor.defaultInterval)}function D(t){switch(t){case"frame":case"mean":case"median":return t;default:return}}function k(t){return"object"==typeof t&&null!=t&&"measureStart"in t?t:void("object"==typeof t&&null!=t&&"measure"in t&&console.warn("The API of `ProfilerBladeDefaultMeasureHandler` has been changed in v0.4.0! Please define `measureStart` instead of `measure`. Fallback to the default measure handler."))}const x=l({id:"profiler",type:"blade",accept(t){const e=o(t,(t=>({view:t.required.constant("profiler"),targetDelta:t.optional.number,bufferSize:t.optional.number,deltaUnit:t.optional.string,fractionDigits:t.optional.number,calcMode:t.optional.custom(D),label:t.optional.string,interval:t.optional.number,measureHandler:t.optional.custom(k)})));return e?{params:e}:null},controller(t){var e,r,i,a,n,s,l;const o=null!==(e=t.params.interval)&&void 0!==e?e:500,c=null!==(r=t.params.targetDelta)&&void 0!==r?r:16.67,u=null!==(i=t.params.bufferSize)&&void 0!==i?i:30,p=null!==(a=t.params.deltaUnit)&&void 0!==a?a:"ms",m=null!==(n=t.params.fractionDigits)&&void 0!==n?n:2,f=null!==(s=t.params.calcMode)&&void 0!==s?s:"mean",v=null!==(l=t.params.measureHandler)&&void 0!==l?l:new _;return new d(t.document,{blade:t.blade,labelProps:h.fromObject({label:t.params.label}),valueController:new M(t.document,{ticker:S(t.document,o),targetDelta:c,bufferSize:u,deltaUnit:p,fractionDigits:m,calcMode:f,viewProps:t.viewProps,measureHandler:v})})},api:t=>t.controller instanceof d?new c(t.controller):null}),P="profiler",U=".tp-profilerv{position:relative}.tp-profilerv_root{background-color:var(--mo-bg);width:100%;height:calc(2*var(--cnt-usz))}.tp-profilerv_entryrect{rx:var(--bld-br);ry:var(--bld-br);stroke:rgba(0,0,0,0);stroke-width:1px;filter:saturate(0.5)}.tp-profilerv_entryrect:hover{filter:saturate(1)}.tp-profilerv_tooltip{position:absolute;right:100%;top:0;overflow:hidden;background:var(--bs-bg)}.tp-profilerv_tooltipinside{padding:0 4px;overflow:visible;white-space:pre;text-align:right;background:var(--mo-bg);color:var(--in-fg)}.tp-profilerv_label{color:var(--mo-fg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}",T=[x];export{_ as ProfilerBladeDefaultMeasureHandler,x as ProfilerBladePlugin,U as css,P as id,x as plugin,T as plugins};
