<script context="module"></script>

<script generics="T extends PointValue2d | PointValue3d | PointValue4d">
	import ClsPad from '../internal/ClsPad.svelte';
	import GenericInputFolding from '../internal/GenericInputFolding.svelte';
	import { removeKeys } from '../utils';
	import { BROWSER } from 'esm-env';
	export let value;
	export let expanded = $$props.expanded ?? void 0;
	let pointerScale = $$props['pointerScale'] ?? void 0;
	let keyScale = $$props['keyScale'] ?? void 0;
	let min = $$props['min'] ?? void 0;
	let max = $$props['max'] ?? void 0;
	let step = $$props['step'] ?? void 0;
	let optionsX = $$props['optionsX'] ?? void 0;
	let optionsY = $$props['optionsY'] ?? void 0;
	let optionsZ = $$props['optionsZ'] ?? void 0;
	let optionsW = $$props['optionsW'] ?? void 0;
	let format = $$props['format'] ?? void 0;
	let internalValue;
	let options;
	const buttonClass = 'tp-p2dv_b';
	function updateInternalValue() {
		if (Array.isArray(value)) {
			if (value.length === 4) {
				const [x, y, z, w] = value;
				internalValue = { x, y, z, w };
			} else if (value.length === 3) {
				const [x, y, z] = value;
				internalValue = { x, y, z };
			} else {
				const [x, y] = value;
				internalValue = { x, y };
			}
		} else {
			internalValue = value;
		}
	}
	function updateValue() {
		if (Array.isArray(value)) {
			if ('w' in internalValue) {
				const { x, y, z, w } = internalValue;
				value = [x, y, z, w];
			} else if ('z' in internalValue) {
				const { x, y, z } = internalValue;
				value = [x, y, z];
			} else {
				const { x, y } = internalValue;
				value = [x, y];
			}
		} else {
			value = internalValue;
		}
	}
	$: value, updateInternalValue();
	$: internalValue, updateValue();
	$: options = {
		x: optionsX,
		y: optionsY,
		z: optionsZ,
		w: optionsW,
		min,
		max,
		format,
		keyScale,
		pointerScale,
		step
	};
</script>

<GenericInputFolding
	bind:value={internalValue}
	bind:expanded
	on:change
	{buttonClass}
	{options}
	{...removeKeys(
		$$restProps,
		...Object.keys(options),
		'optionsX',
		'optionsY',
		'optionsZ',
		'optionsW'
	)}
/>
{#if !BROWSER && !('z' in internalValue)}
	<!-- 2D points only -->
	{#if expanded && $$props.picker === 'inline'}
		{#if $$props.label !== undefined}
			<ClsPad
				keysAdd={['bladeValueWidth']}
				keysSubtract={[`containerUnitSize`]}
				theme={$$props.theme}
			/>
		{:else}
			<!-- Without a label, the grid takes the full width of the control -->
			<!-- TODO remove magic number -->
			<div style="aspect-ratio: 1; width: calc(100% - 28px);"></div>
		{/if}
	{/if}
{/if}
