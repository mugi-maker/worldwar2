<!--
@component `<Controller />` represents a THREE.XRTargetRaySpace, a THREE.XRGripSpace, and a controller model.
-->
<script
 
  context="module"
>import { writable } from "svelte/store";
import { T, createRawEventDispatcher } from "@threlte/core";
import { left as leftStore, right as rightStore } from "../hooks/useController";
import {
  isHandTracking,
  pointerState,
  teleportState,
  controllerDispatchers
} from "../internal/stores";
import PointerCursor from "./internal/PointerCursor.svelte";
import ShortRay from "./internal/ShortRay.svelte";
import ScenePortal from "./internal/ScenePortal.svelte";
import TeleportCursor from "./internal/TeleportCursor.svelte";
import TeleportRay from "./internal/TeleportRay.svelte";
const stores = {
  left: leftStore,
  right: rightStore
};
</script>

<script>export let left = void 0;
export let right = void 0;
export let hand = void 0;
const dispatch = createRawEventDispatcher();
const handedness = writable(left ? "left" : right ? "right" : hand);
$:
  handedness.set(left ? "left" : right ? "right" : hand);
controllerDispatchers[$handedness].set(dispatch);
$:
  controllerDispatchers[$handedness].set(dispatch);
$:
  store = stores[$handedness];
$:
  grip = $store?.grip;
$:
  targetRay = $store?.targetRay;
$:
  model = $store?.model;
$:
  hasPointerControls = $pointerState[$handedness].enabled;
$:
  hasTeleportControls = $teleportState[$handedness].enabled;
</script>

{#if !$isHandTracking}
  {#if grip}
    <T is={grip}>
      <slot>
        <T is={model} />
      </slot>

      <slot name="grip" />
    </T>
  {/if}

  {#if targetRay}
    <T is={targetRay}>
      <slot name="target-ray" />

      {#if hasPointerControls || hasTeleportControls}
        {#if $$slots['pointer-ray']}
          <ShortRay handedness={$handedness}>
            <slot name="pointer-ray" />
          </ShortRay>
        {:else}
          <ShortRay handedness={$handedness} />
        {/if}
      {/if}
    </T>
  {/if}
{/if}

<ScenePortal>
  {#if hasPointerControls}
    {#if $$slots['pointer-cursor']}
      <PointerCursor handedness={$handedness}>
        <slot name="pointer-cursor" />
      </PointerCursor>
    {:else}
      <PointerCursor handedness={$handedness} />
    {/if}
  {/if}

  {#if hasTeleportControls && targetRay !== undefined}
    {#if $$slots['teleport-ray']}
      <TeleportRay
        {targetRay}
        handedness={$handedness}
      >
        <slot name="teleport-ray" />
      </TeleportRay>
    {:else}
      <TeleportRay
        {targetRay}
        handedness={$handedness}
      />
    {/if}

    {#if $$slots['teleport-ray']}
      <TeleportCursor handedness={$handedness}>
        <slot name="teleport-cursor" />
      </TeleportCursor>
    {:else}
      <TeleportCursor handedness={$handedness} />
    {/if}
  {/if}
</ScenePortal>
