<!--
	This component is responsible for:
	- Creating namespaces
	- Potentially Providing a sheet object
-->
<script>import { useStudio } from '../studio/useStudio';
import { createRawEventDispatcher, currentWritable, watch, useThrelte } from '@threlte/core';
import { getContext, onDestroy, onMount } from 'svelte';
import Declare from './declare/Declare.svelte';
import Sync from './sync/Sync.svelte';
import Transform from './transform/Transform.svelte';
export let key;
export let detach = false;
export let props = undefined;
const { invalidate } = useThrelte();
let aggregatedProps = { ...props };
const { sheet } = getContext('theatre-sheet');
const sheetObject = currentWritable(sheet.object(key, aggregatedProps, {
    reconfigure: true
}));
const dispatch = createRawEventDispatcher();
onMount(() => {
    // Because the sheet object value subscription is not running before any
    // values change, we're emitting the initial value here. Doing this in
    // onMount also means that child components which might add props to the
    // sheet object have already been mounted.
    dispatch('change', sheetObject.current.value);
});
// This flag is used to prevent the sheet object from being created after it
// has been detached.
let detached = false;
onDestroy(() => {
    if (detach) {
        detached = true;
        sheet.detachObject(key);
    }
});
const updateSheetObject = () => {
    // if the sheetObject has already been detached, do nothing.
    if (detached)
        return;
    // first, detach the sheet object.
    sheet.detachObject(key);
    // create or reconfigure a sheet object here.
    sheetObject.set(sheet.object(key, aggregatedProps, {
        reconfigure: true
    }));
};
const addProps = (props) => {
    // add props to list of props
    aggregatedProps = {
        ...aggregatedProps,
        ...props
    };
    // update sheet object (create or reconfigure)
    updateSheetObject();
};
const removeProps = (propNames) => {
    // remove props from sheet object
    propNames.forEach((prop) => {
        delete aggregatedProps[prop];
    });
    // if there are no more props, detach sheet object
    if (Object.keys(aggregatedProps).length === 0) {
        // detach sheet object
        if (detach) {
            sheet.detachObject(key);
        }
    }
    else {
        // update sheet object (reconfigure)
        updateSheetObject();
    }
};
const augmentConstructorArgs = (args) => {
    return {
        ...args,
        props: {
            ...args.props,
            sheetObject,
            addProps,
            removeProps
        }
    };
};
const proxySyncComponent = new Proxy(Sync, {
    construct(_target, [args]) {
        return new Sync(augmentConstructorArgs(args));
    }
});
const proxyTransformComponent = new Proxy(Transform, {
    construct(_target, [args]) {
        return new Transform(augmentConstructorArgs(args));
    }
});
const proxyDeclareComponent = new Proxy(Declare, {
    construct(_target, [args]) {
        return new Declare(augmentConstructorArgs(args));
    }
});
let values = $sheetObject?.value;
watch(sheetObject, (sheetObject) => {
    return sheetObject.onValuesChange((newValues) => {
        dispatch('change', newValues);
        values = newValues;
        // this invalidation also invalidates changes catched by slotted
        // components such as <Sync> or <Declare>.
        invalidate();
    });
});
// Provide a flag to indicate whether this sheet object is selected in the
// Theatre.js studio.
const studio = useStudio();
export let selected = false;
watch([studio, sheetObject], ([studio, sheetObject]) => {
    return studio?.onSelectionChange((selection) => {
        selected = selection.includes(sheetObject);
    });
});
// Provide a select function to select this sheet object in the Theatre.js
// studio.
const select = () => {
    $studio?.setSelection([sheetObject.current]);
};
const deselect = () => {
    if ($studio?.selection.includes(sheetObject.current)) {
        $studio?.setSelection([]);
    }
};
</script>

<slot
  {values}
  {selected}
  {select}
  {deselect}
  sheetObject={$sheetObject}
  Sync={proxySyncComponent}
  Transform={proxyTransformComponent}
  Declare={proxyDeclareComponent}
/>
